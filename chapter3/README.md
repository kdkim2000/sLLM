# Chapter 3: RAG (Retrieval Augmented Generation)

## ğŸ“– ê°œìš”

**RAG**ëŠ” Retrieval Augmented Generationì˜ ì•½ìë¡œ, 
LLMì´ ì •í™•í•˜ê³  ì‹ ë¢°ì„± ìˆëŠ” ë‹µë³€ì„ ì œê³µí•˜ê¸° ìœ„í•´ ì™¸ë¶€ ì§€ì‹ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ì—¬ í™œìš©í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.

LLMì˜ í•œê³„(ì§€ì‹ ë¶€ì¡±, í™˜ê° í˜„ìƒ)ë¥¼ ë³´ì™„í•˜ëŠ” ê°€ì¥ ëŒ€í‘œì ì¸ ì ‘ê·¼ ë°©ë²•ì…ë‹ˆë‹¤.

---

## 3.1 RAGì˜ í•„ìš”ì„±

| ë¬¸ì œ | ì„¤ëª… |
|:---|:---|
| í™˜ê°(Hallucination) | LLMì´ ì‚¬ì‹¤ê³¼ ë‹¤ë¥¸ ë‚´ìš©ì„ ìì‹  ìˆê²Œ ìƒì„± |
| ìµœì‹  ì •ë³´ ë¶€ì¡± | í›ˆë ¨ ì‹œì  ì´í›„ ë°ì´í„° ë°˜ì˜ ì–´ë ¤ì›€ |
| ë„ë©”ì¸ í•œê³„ | íŠ¹ì • ë¶„ì•¼(ë²•ë¥ , ê¸ˆìœµ ë“±) ì§€ì‹ ë¶€ì¡± |

> âœ… **RAG**ëŠ” í•„ìš”í•œ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ì—¬ í”„ë¡¬í”„íŠ¸ì— í•¨ê»˜ ì œê³µ, LLMì˜ ë‹µë³€ ì •í™•ë„ë¥¼ ë†’ì—¬ì¤ë‹ˆë‹¤.


## 3.2 RAGì˜ ê¸°ë³¸ êµ¬ì¡°

```mermaid
graph TD
    UserQuery[ì‚¬ìš©ì ì§ˆë¬¸]
    QueryProcessing[ì¿¼ë¦¬ ì „ì²˜ë¦¬]
    Retriever[ì—°ê´€ ë¬¸ì„œ ê²€ìƒ‰]
    ContextAugmentation[ê²€ìƒ‰ ê²°ê³¼ë¡œ í”„ë¡¬í”„íŠ¸ ê°•í™”]
    LLM[LLM ì‘ë‹µ ìƒì„±]
    FinalAnswer[ìµœì¢… ë‹µë³€]

    UserQuery --> QueryProcessing
    QueryProcessing --> Retriever
    Retriever --> ContextAugmentation
    ContextAugmentation --> LLM
    LLM --> FinalAnswer
```

**RAG íë¦„ ìš”ì•½**:
- ì‚¬ìš©ì ì§ˆë¬¸ì„ ì „ì²˜ë¦¬
- ì—°ê´€ ë¬¸ì„œ ê²€ìƒ‰
- ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ê°•í™”
- ìµœì¢… ë‹µë³€ ìƒì„±


## 3.3 RAGì˜ 5ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤

| ë‹¨ê³„ | ì„¤ëª… |
|:---|:---|
| 1. Indexing | ì§€ì‹ ë¬¸ì„œë¥¼ ì²­í¬(chunk) ë‹¨ìœ„ë¡œ ë‚˜ëˆ  ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ |
| 2. Processing | ì¿¼ë¦¬(ì§ˆë¬¸)ë¥¼ ì „ì²˜ë¦¬í•˜ì—¬ ê²€ìƒ‰ ìµœì í™” |
| 3. Searching | ê´€ë ¨ ë¬¸ì„œë¥¼ ì„ë² ë”©(Embedding) ê¸°ë°˜ìœ¼ë¡œ ê²€ìƒ‰ |
| 4. Augmenting | ê²€ìƒ‰ ê²°ê³¼ë¥¼ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€ |
| 5. Generating | LLMì´ ìµœì¢… ë‹µë³€ ìƒì„± |


## 3.4 Indexing: ë¬¸ì„œ ì¤€ë¹„ ë° ì €ì¥

- **ì²­í¬(Chunking)**: ë¬¸ì„œë¥¼ ì‘ê²Œ ë‚˜ëˆ„ì–´ ì €ì¥
- **ì ì ˆí•œ ì²­í¬ ì‚¬ì´ì¦ˆ ì„ íƒ**ì´ ì¤‘ìš”

| ì²­í¬ í¬ê¸° | ì¥ì  | ë‹¨ì  |
|:---|:---|:---|
| ì‘ìŒ | ê²€ìƒ‰ ì •í™•ë„ ë†’ìŒ | ë¬¸ë§¥ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìŒ |
| í¼ | ë¬¸ë§¥ ìœ ì§€ ê°€ëŠ¥ | ë¶ˆí•„ìš” ì •ë³´ í¬í•¨ ê°€ëŠ¥ |

> ğŸ’¡ ì¼ë°˜ì ìœ¼ë¡œ 300~500 í† í°(chunk) í¬ê¸°ê°€ ë§ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.


## 3.5 Searching: ê²€ìƒ‰ ë°©ë²•

| ë°©ë²• | ì„¤ëª… |
|:---|:---|
| Semantic ê²€ìƒ‰ | ë¬¸ì¥ì˜ ì˜ë¯¸ë¥¼ ë²¡í„°ë¡œ ë³€í™˜ í›„ ìœ ì‚¬ë„ ê¸°ë°˜ ê²€ìƒ‰ |
| Lexical ê²€ìƒ‰ | í‚¤ì›Œë“œ ì¼ì¹˜ ê¸°ë°˜ ê²€ìƒ‰ (BM25, TF-IDF ë“±) |
| Hybrid ê²€ìƒ‰ | Semantic + Lexical ê²°í•© |


### ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ì˜ˆì‹œ

| ë²¡í„°DB | íŠ¹ì§• |
|:---|:---|
| Pinecone | í´ë¼ìš°ë“œ ê¸°ë°˜ ëŒ€ê·œëª¨ ì„œë¹„ìŠ¤ |
| Chroma | ë¡œì»¬ ì‚¬ìš©ì— ì í•©, ì˜¤í”ˆì†ŒìŠ¤ |
| Milvus, Qdrant, Weaviate | ê³ ì„±ëŠ¥ ë¬´ë£Œ ë²¡í„° DB ì§€ì› |

```mermaid
graph TD
    Embedding[í…ìŠ¤íŠ¸ â†’ ë²¡í„° ì„ë² ë”©]
    VectorDB[ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥]
    SearchQuery[ì§ˆë¬¸ ì„ë² ë”©]
    TopKRetrieval[Top-K ìœ ì‚¬ ë¬¸ì„œ ê²€ìƒ‰]

    Embedding --> VectorDB
    SearchQuery --> VectorDB
    VectorDB --> TopKRetrieval
```


## 3.6 Augmenting: í”„ë¡¬í”„íŠ¸ ê°•í™”

- ê²€ìƒ‰ëœ ë¬¸ì„œë¥¼ í”„ë¡¬í”„íŠ¸ì— ì‚½ì…í•˜ì—¬ LLMì´ ë‹µë³€ ìƒì„± ì‹œ ì°¸ì¡°í•˜ë„ë¡ í•¨
- í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ:

```text
ë‹¤ìŒ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”.

---

Context:
"'AíšŒì‚¬ëŠ” 1995ë…„ì— ì„¤ë¦½ë˜ì—ˆê³ , AI ê¸°ìˆ ì„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤."

Question:
"AíšŒì‚¬ëŠ” ì–´ë–¤ ë¶„ì•¼ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•˜ë‚˜ìš”?"
```


## 3.7 Generating: ìµœì¢… ë‹µë³€ ìƒì„±

- LLMì€ Augmented Promptë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ ìƒì„±
- ê²€ìƒ‰ ê²°ê³¼ í’ˆì§ˆì— ë”°ë¼ ë‹µë³€ì˜ ì •í™•ë„ë„ ë‹¬ë¼ì§


## 3.8 RAGì˜ ì£¼ìš” ê³ ë ¤ì‚¬í•­

| ê³ ë ¤ì‚¬í•­ | ì„¤ëª… |
|:---|:---|
| ì²­í‚¹(Chunking) ì „ëµ | ë¬¸ì„œ ë¶„ë¦¬ ë°©ë²•ì— ë”°ë¼ ê²€ìƒ‰ í’ˆì§ˆ ì˜í–¥ |
| ì¿¼ë¦¬ ì „ì²˜ë¦¬ | ì˜ë¯¸ ìˆëŠ” ê²€ìƒ‰ì„ ìœ„í•œ ì§ˆë¬¸ ì •ì œ í•„ìš” |
| ê²€ìƒ‰ ì •í™•ë„ | ê²€ìƒ‰ëœ ë¬¸ì„œ í’ˆì§ˆì´ ë‹µë³€ í’ˆì§ˆì„ ê²°ì • |
| í”„ë¡¬í”„íŠ¸ êµ¬ì„± | Context ì‚½ì… ìœ„ì¹˜ì™€ ì–‘ ì¡°ì ˆ ì¤‘ìš” |


## 3.9 ì‹¤ìŠµ ì˜ˆì œ: ê°„ë‹¨í•œ RAG ì–´í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¶•

```python
from langchain.prompts import PromptTemplate
from langchain.llms import OpenAI
from langchain.vectorstores import Chroma
from langchain.embeddings.openai import OpenAIEmbeddings
from langchain.chains import RetrievalQA

# ë²¡í„°DB ì´ˆê¸°í™” (ë¬¸ì„œ ì €ì¥)
db = Chroma(persist_directory="./chroma_db", embedding_function=OpenAIEmbeddings())

# ê²€ìƒ‰ + QA ì²´ì¸ êµ¬ì„±
retriever = db.as_retriever()
rag_chain = RetrievalQA.from_chain_type(
    llm=OpenAI(),
    chain_type="stuff",
    retriever=retriever
)

# ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•œ ì‘ë‹µ ìƒì„±
query = "AíšŒì‚¬ëŠ” ì–´ë–¤ ê¸°ìˆ ì„ ì „ë¬¸ìœ¼ë¡œ í•˜ë‚˜ìš”?"
response = rag_chain.run(query)

print("ë‹µë³€:", response)
```

> âœ… ì‹¤ì œ ë¬¸ì„œë¥¼ ì„ë² ë”©í•˜ì—¬ ê²€ìƒ‰í•˜ê³ , ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ê¸°ë³¸ êµ¬ì¡°ì…ë‹ˆë‹¤.


---

# ğŸ“Œ ìš”ì•½ í‚¤ì›Œë“œ

- Retrieval
- Chunking
- Embedding
- Vector Search
- Contextual Prompting
- Augmented Generation

---

